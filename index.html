<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ChatBot</title>

<!-- Fonts (system stack) – no external CSS frameworks -->
<style>
  /* ====== THEME ====== */
  :root{
    --bg-0:#06070d;
    --bg-1:#0a0d1f;
    --bg-2:#0e1330;
    --glass:rgba(255,255,255,.06);
    --glass-2:rgba(255,255,255,.1);
    --border: rgba(255,255,255,.14);
    --text:#e8f0ff;
    --muted:#9fb0c7;
    --accent:#00e6ff;
    --accent-2:#7a5cff;
    --hot:#ff6b9d;
    --success:#00ffa7;
    --shadow: 0 15px 60px rgba(0,0,0,.45), inset 0 0 40px rgba(255,255,255,.03);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; color:var(--text);
    font-family: Inter, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    background: radial-gradient(1200px 600px at 10% -10%, #13235a33 0%, transparent 60%),
                radial-gradient(900px 500px at 120% 10%, #00e6ff22 0%, transparent 60%),
                linear-gradient(180deg, var(--bg-1), var(--bg-0));
    overflow:hidden; /* we'll provide an inner scroller */
  }

  /* ====== COSMIC BACKGROUND ====== */
  canvas#stars{
    position:fixed; inset:0; z-index:-3;
  }
  .orb{
    position:fixed; width:38vmax; height:38vmax; filter: blur(60px);
    border-radius:50%;
    background:conic-gradient(from 0deg, #00e6ff33, #7a5cff33, #ff7ad633, #00e6ff33);
    animation: spin 24s linear infinite;
    mix-blend-mode: screen; opacity:.35; z-index:-2;
  }
  .orb.o1{ top:-10vmax; left:-10vmax; animation-duration: 38s;}
  .orb.o2{ bottom:-12vmax; right:-8vmax; animation-direction: reverse;}
  @keyframes spin{to{transform:rotate(1turn)}}

  /* grid glow */
  .grid{
    position:fixed; inset:0; z-index:-1; pointer-events:none;
    background:
      radial-gradient(1000px 400px at 50% 100%, #00e6ff0a, transparent 60%),
      repeating-linear-gradient(90deg, transparent 0 44px, #ffffff08 45px 46px),
      repeating-linear-gradient(0deg,  transparent 0 44px, #ffffff08 45px 46px);
    mask: radial-gradient(70% 35% at 50% 100%, transparent 20%, #000 80%);
  }

  /* ====== LAYOUT ====== */
  .shell{
    position:relative; height:100%; display:grid;
    grid-template-rows: auto 1fr auto;
    max-width: 980px; margin: 0 auto;
    padding: 18px; gap: 14px;
  }
  .glass{
    background: linear-gradient(180deg, var(--glass), transparent 80%);
    border: 1px solid var(--border);
    backdrop-filter: blur(16px);
    border-radius: 16px;
    box-shadow: var(--shadow);
    position:relative; overflow:hidden;
  }
  /* animated border glow */
  .glass::after{
    content:""; position:absolute; inset:-2px;
    border-radius: 18px;
    padding:2px; pointer-events:none;
    background: conic-gradient(from var(--angle,0deg), var(--accent), var(--accent-2), var(--hot), var(--accent));
    -webkit-mask:
      linear-gradient(#000 0 0) content-box, 
      linear-gradient(#000 0 0);
    -webkit-mask-composite: xor; mask-composite: exclude;
    animation: borderSpin 8s linear infinite;
    opacity:.15;
  }
  @keyframes borderSpin{to{--angle:360deg}}

  /* ===== HEADER ===== */
  .header{
    padding: 14px 18px; display:flex; align-items:center; justify-content:space-between;
    position:sticky; top:18px; z-index:5;
  }
  .brand{
    display:flex; align-items:center; gap:12px;
  }
  .brand .logo{
    width:38px; height:38px; border-radius:10px;
    background: radial-gradient(circle at 30% 30%, #fff 0 2px, #00e6ff 3px 12px, #7a5cff 18px, transparent 40px);
    box-shadow: 0 0 24px #00e6ff66, inset 0 0 18px #7a5cff66;
    animation: float 5s ease-in-out infinite;
  }
  @keyframes float{
    0%,100%{ transform: translateY(0) }
    50%{ transform: translateY(-4px) }
  }
  h1{
    font-size: clamp(18px, 2.4vw, 22px); margin:0;
    letter-spacing:.3px; font-weight:700;
    background: linear-gradient(90deg, #fff, #c9eaff, #a0a8ff, #ffd1e7);
    -webkit-background-clip:text; -webkit-text-fill-color: transparent;
  }
  .sub{
    color:var(--muted); font-size:.9rem; margin-top:2px;
  }

  /* ===== WELCOME / HERO STRIP ===== */
  .hero{
    padding:18px 18px 8px;
    overflow:hidden;
  }
  .spark{
    position:absolute; inset:0; background:
      radial-gradient(600px 200px at 10% 0%, #00e6ff14, transparent 70%),
      radial-gradient(600px 200px at 90% 0%, #7a5cff14, transparent 70%);
    pointer-events:none; animation: shimmer 8s ease-in-out infinite alternate;
  }
  @keyframes shimmer{
    0%{ opacity:.4; transform:translateY(0) }
    100%{ opacity:.75; transform:translateY(-6px) }
  }
  .hero h2{
    margin:0 0 6px; font-size: clamp(18px, 2.2vw, 20px);
    color:#d8e7ff; font-weight:600;
  }
  .chips{ display:flex; flex-wrap:wrap; gap:10px; margin-top:10px }
  .chip{
    padding:8px 12px; border-radius:999px; font-size:.85rem;
    background: linear-gradient(180deg, #ffffff12, #ffffff06);
    border:1px solid var(--border); color:#cfe7ff;
    transition:.25s transform, .25s box-shadow;
  }
  .chip:hover{ transform: translateY(-2px); box-shadow: 0 10px 30px #00e6ff22 }

  /* ===== CHAT SCROLLER ===== */
  .chat{
    padding:18px; overflow:auto;
    scroll-behavior:smooth; max-height: 60vh;
  }
  .message{
    display:flex; gap:12px; margin: 14px 0; align-items:flex-start;
    opacity:0; transform: translateY(20px) scale(.98) rotateX(12deg);
    animation: pop .5s cubic-bezier(.2,.8,.2,1) forwards;
    transform-origin: top center;
  }
  .message.user{ flex-direction: row-reverse }
  @keyframes pop{
    to{ opacity:1; transform: translateY(0) scale(1) rotateX(0) }
  }
  .avatar{
    width:38px; height:38px; border-radius:12px; display:grid; place-items:center; flex-shrink:0;
    background: linear-gradient(135deg, #00e6ff44, #7a5cff44);
    border:1px solid var(--border);
    box-shadow: inset 0 0 12px #ffffff0f, 0 0 24px #00e6ff22;
  }
  .message.user .avatar{
    background: linear-gradient(135deg, #5f7bff66, #a64bff66);
  }
  .bubble{
    max-width:min(76%, 720px);
    padding:16px 18px; border-radius:18px; position:relative;
    background:linear-gradient(180deg, #ffffff10, #ffffff06);
    border:1px solid var(--border); backdrop-filter: blur(10px);
    box-shadow: var(--shadow);
  }
  .message.user .bubble{
    background: linear-gradient(180deg, #5f7bff33, #00e6ff22);
    border-image: linear-gradient(90deg, #7a5cffaa, #00e6ffaa) 1;
  }
  .bubble .md h1,.bubble .md h2,.bubble .md h3{ 
    margin: 10px 0; font-weight:700; 
    color: #bfe9ff; 
  }
  .bubble .md p{ margin: 10px 0; color:#e7f2ff }
  .bubble .md code{
    background:#0f1738; padding:2px 6px; border-radius:6px; color:#8fd8ff
  }
  .bubble .md pre{
    background:#0d132c; border:1px solid #2b3566; border-radius:12px; padding:14px; overflow:auto
  }
  .file-attachment{
    margin-top:10px; border:1px dashed #2b3a66; border-radius:10px;
    padding:12px; display:flex; gap:10px; align-items:center;
    background: linear-gradient(180deg, #ffffff0b, transparent);
  }
  .file-attachment .file-name{font-weight:600}
  .profit-amount{ color: var(--success); font-weight:700 }

  /* fancy typing */
  .typing{
    display:none; align-items:center; gap:12px; margin:14px 0;
  }
  .typing.show{ display:flex }
  .dots{ display:flex; gap:6px }
  .dot{ width:10px; height:10px; border-radius:50%;
    background: radial-gradient(circle at 30% 30%, #fff, #00e6ff);
    box-shadow: 0 0 14px #00e6ff88; animation: bounce 1.2s infinite;
  }
  .dot:nth-child(2){ animation-delay:.15s }
  .dot:nth-child(3){ animation-delay:.3s }
  @keyframes bounce{
    0%,80%,100%{ transform:translateY(0); opacity:.7 }
    40%{ transform:translateY(-6px); opacity:1 }
  }

  /* ===== INPUT BAR ===== */
  .composer{
    padding:12px; display:grid; gap:10px;
    position:sticky; bottom:18px; z-index: 3;
  }
  .file-pill{ display:none; align-items:center; gap:12px;
    border:1px dashed #3a4a7a; padding:10px 12px; border-radius:12px;
    background: linear-gradient(180deg, #ffffff10, #ffffff06);
  }
  .file-pill.show{ display:flex }
  .row{
    display:flex; gap:10px; align-items:flex-end;
    position:relative;
  }
  textarea{
    flex:1; resize:none; min-height:46px; max-height:160px; 
    padding:14px 16px; border-radius:16px; outline:none; 
    color:var(--text); border:1px solid var(--border); 
    background: linear-gradient(180deg, #ffffff0a, #ffffff06);
    backdrop-filter: blur(12px);
    transition: box-shadow .25s, border-color .25s, transform .2s;
  }
  textarea::placeholder{ color:#9ab0cc }
  textarea:focus{
    border-color:#7a5cff; box-shadow: 0 0 0 2px #7a5cff33, 0 10px 30px #7a5cff22; transform: translateY(-1px);
  }
  .btn, .icon-btn{
    border:none; cursor:pointer; color:#00111a; font-weight:700;
    transition: transform .15s ease, box-shadow .15s ease, background .15s ease;
  }
  .icon-btn{
    width:52px; height:52px; border-radius:14px;
    display:grid; place-items:center;
    background: radial-gradient(100% 100% at 30% 20%, #00e6ff, #7a5cff);
    color:white; box-shadow: 0 12px 30px #00e6ff55;
  }
  .icon-btn:hover{ transform: translateY(-2px) rotate(-2deg) }
  .send{
    padding: 15px 20px; border-radius:14px; color:white;
    background: conic-gradient(from 140deg, #00e6ff, #7a5cff, #ff7ad6, #00e6ff);
    box-shadow: 0 12px 30px #00e6ff55;
  }
  .send:hover{ transform: translateY(-2px) }
  .send:active{ transform: translateY(0) scale(.98) }

  /* send rocket trail */
  .send::after{
    content:""; position:absolute; width:8px; height:8px; border-radius:50%;
    background:#fff; filter: blur(6px); opacity:0; transform: translateY(6px);
    transition: .25s; pointer-events:none;
  }
  .send:hover::after{ opacity:1; transform: translateY(-8px) }

  /* Scrollbar */
  ::-webkit-scrollbar{ width:8px; height:8px }
  ::-webkit-scrollbar-thumb{ background:#2a3455; border-radius:8px }
  ::-webkit-scrollbar-thumb:hover{ background:#4d60a8 }

  /* Reduced motion */
  @media (prefers-reduced-motion: reduce){
    .orb,.glass::after,.brand .logo,.message{ animation:none !important }
    .chat{ scroll-behavior:auto }
  }
</style>
</head>
<body>
  <!-- animated background layers -->
  <canvas id="stars"></canvas>
  <div class="orb o1"></div>
  <div class="orb o2"></div>
  <div class="grid"></div>

  <main class="shell">
    <!-- HEADER -->
    <header class="glass header" id="header">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1>ChatBot</h1>
          <div class="sub">glowing assistant</div>
        </div>
      </div>
      <div class="chips" aria-label="quick actions">
        <button class="chip" onclick="useExample('Give me a TL;DR of today’s market in 3 bullets.')">TL;DR Market</button>
        <button class="chip" onclick="useExample('Explain dollar-cost averaging like I’m 12.')">DCA 🧒</button>
        <button class="chip" onclick="useExample('List 5 risks of over-diversification.')">Risks ⚠️</button>
      </div>
    </header>

    <!-- HERO WELCOME -->
    <section class="glass hero" id="welcomeCard">
      <div class="spark"></div>
      <h2>👋 Welcome! Ask anything.</h2>
      <div class="chips" style="margin-top:8px;">
        <button class="chip" onclick="useExample('Give me a list of the top 5 banks by revenue')">Top 5 Banks by Revenue</button>
        <button class="chip" onclick="useExample('What are the top 5 oil-gas-coal companies by market cap?')">Top 5 Mining Companies by Market Cap</button>
        <button class="chip" onclick="useExample('What is the latest news for the top 3 telecommunication companies?')">News - Top 3 Telecommunication Companies</button>
      </div>
    </section>

    <!-- CHAT -->
    <section class="glass chat" id="chatContainer" aria-live="polite">
      <!-- messages appended here -->
      <div class="typing" id="typingIndicator">
        <div class="avatar">🤖</div>
        <div class="bubble">
          <div class="dots"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>
        </div>
      </div>
    </section>

    <!-- COMPOSER -->
    <section class="composer">
      <div id="filePill" class="file-pill">
        <div>📎 <strong class="file-name" id="selectedFileName"></strong>
          <span style="color:#9fb0c7" id="selectedFileSize"></span>
        </div>
        <button class="chip" onclick="removeFile()">Remove</button>
      </div>
      <div class="row">
        <input type="file" id="fileInput" class="hidden" style="display:none"
               accept=".pdf,.doc,.docx,.xls,.xlsx,.csv,.txt,.png,.jpg,.jpeg"
               onchange="handleFileSelect(event)"/>
        <button class="icon-btn" title="Attach file" onclick="document.getElementById('fileInput').click()">📎</button>
        <textarea id="messageInput" rows="1" placeholder="Type your prompt…  ⏎ to send"></textarea>
        <button class="send btn" id="sendButton" onclick="sendMessage()">Send 🚀</button>
      </div>
    </section>
  </main>

  <!-- Markdown parser (client-side) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.3.0/marked.min.js" integrity="sha512-8JdQF+Jjz3J0cT3XyT9VJ7t7x0gZ7qf3i4iFhG0T4x3b9z9mXJ9q7qz6i3ZV5wM4zGv3v8Jb8r7lKQw2RQCm8g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

  <script>
    /* ================== STARFIELD ================== */
    const starCanvas = document.getElementById('stars');
    const ctx = starCanvas.getContext('2d');
    let stars=[], w=0, h=0;
    function resize(){
      w = starCanvas.width = innerWidth;
      h = starCanvas.height = innerHeight;
      stars = Array.from({length: Math.min(320, Math.floor(w*h/6000))}, () => ({
        x: Math.random()*w, y: Math.random()*h,
        z: Math.random()*1.2 + .2, r: Math.random()*1.2 + .2,
        vx: (Math.random()-.5)*.15, vy:(Math.random()-.5)*.15
      }));
    }
    addEventListener('resize', resize); resize();
    (function loop(){
      ctx.clearRect(0,0,w,h);
      ctx.fillStyle='#ffffff';
      for(const s of stars){
        s.x+=s.vx; s.y+=s.vy;
        if(s.x<0||s.x>w) s.vx*=-1;
        if(s.y<0||s.y>h) s.vy*=-1;
        ctx.globalAlpha = .3 + s.z*.7;
        ctx.beginPath(); ctx.arc(s.x, s.y, s.r, 0, Math.PI*2); ctx.fill();
      }
      requestAnimationFrame(loop);
    })();

    /* ================== CHAT LOGIC ================== */
    const API_URL = 'https://arbi.app.n8n.cloud/webhook/n8n_chat_agent'; // keep original endpoint
    let sessionId = sessionStorage.getItem("fin_session_id") || (sessionStorage.setItem("fin_session_id", crypto.randomUUID?.() ?? String(Date.now())), sessionStorage.getItem("fin_session_id"));

    const chatContainer = document.getElementById('chatContainer');
    const input = document.getElementById('messageInput');
    const sendBtn = document.getElementById('sendButton');
    const fileInput = document.getElementById('fileInput');
    const filePill = document.getElementById('filePill');
    const selectedFileName = document.getElementById('selectedFileName');
    const selectedFileSize = document.getElementById('selectedFileSize');
    const typing = document.getElementById('typingIndicator');

    marked.setOptions({ breaks:true, gfm:true });

    // Auto-resize textarea
    input.addEventListener('input', function(){
      this.style.height = 'auto';
      this.style.height = Math.min(this.scrollHeight, 160) + 'px';
    });

    // Enter to send
    input.addEventListener('keydown', e=>{
      if(e.key==='Enter' && !e.shiftKey){
        e.preventDefault();
        if(input.value.trim() || fileInput.files[0]) sendMessage();
      }
    });

    // Quick chips
    function useExample(q){ input.value = q; input.focus(); }

    // File handling
    function handleFileSelect(e){
      const f = e.target.files[0]; if(!f) return;
      if(f.size > 10*1024*1024){ alert('Max 10MB'); e.target.value=''; return; }
      filePill.classList.add('show');
      selectedFileName.textContent = f.name;
      selectedFileSize.textContent = ' • ' + formatFileSize(f.size);
    }
    function removeFile(){ fileInput.value=''; filePill.classList.remove('show'); }
    function formatFileSize(b){ const k=1024, u=['B','KB','MB','GB']; let i=0; while(b>=k&&i<u.length-1){b/=k;i++} return b.toFixed(2)+' '+u[i] }

    // Messaging
    function addMessage(html, who='bot', file=null, isError=false){
      const wrap = document.createElement('div');
      wrap.className = 'message '+(who==='user'?'user':'bot');

      const av = document.createElement('div'); av.className='avatar'; av.textContent = who==='user' ? '👤':'🤖';
      const bubble = document.createElement('div'); bubble.className='bubble';

      const text = document.createElement('div'); text.className='md';
      if(who==='bot' && !isError){ text.innerHTML = enhanceFinancial(html) }
      else { text.textContent = html }

      bubble.appendChild(text);

      if(file && who==='user'){
        const fileDiv = document.createElement('div'); fileDiv.className='file-attachment';
        fileDiv.innerHTML = `📎 <span class="file-name">${file.name}</span> <span style="color:#9fb0c7">(${formatFileSize(file.size)})</span>`;
        bubble.appendChild(fileDiv);
      }

      wrap.appendChild(av); wrap.appendChild(bubble);
      chatContainer.insertBefore(wrap, typing);
      setTimeout(()=> chatContainer.scrollTop = chatContainer.scrollHeight, 60);
    }

    function showTyping(){ typing.classList.add('show'); setTimeout(()=> chatContainer.scrollTop = chatContainer.scrollHeight, 30) }
    function hideTyping(){ typing.classList.remove('show') }

    function enhanceFinancial(html){
      // enrich headings + currency + percentages
      let out = html;
      out = out.replace(/<h2>([^<]+)<\/h2>/g, '<h2>💡 $1</h2>');
      out = out.replace(/(\d+(?:[.,]\d+)?%)/g, '<span class="profit-amount">📈 $1</span>');
      out = out.replace(/(IDR|USD|Rp)\s?([\d.,]+)/g, '<span class="profit-amount">💰 $1 $2</span>');
      return out;
    }

    async function sendMessage(){
      const text = input.value.trim();
      const file = fileInput.files[0] || null;
      if(!text && !file) return;

      addMessage(text, 'user', file);
      input.value=''; input.style.height='auto'; removeFile();
      sendBtn.disabled = true; showTyping();

      try{
        const body = { chatInput: text, session_id: sessionId };
        if(file){ body.attachment = { fileName:file.name, fileType:file.type, fileSize:file.size, fileData: await fileToBase64(file) } }

        const res = await fetch(API_URL, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) });
        if(!res.ok) throw new Error('HTTP '+res.status);
        const data = await res.json();
        await new Promise(r=>setTimeout(r, 600));
        hideTyping();
        addMessage(data.AIResponse || 'No response', 'bot');
      }catch(err){
        hideTyping();
        addMessage('🚨 Connection error. Please try again.', 'bot', null, true);
        console.error(err);
      }finally{
        sendBtn.disabled = false; input.focus();
      }
    }

    function fileToBase64(file){
      return new Promise((resolve,reject)=>{
        const r = new FileReader();
        r.onload = ()=> resolve(r.result.split(',')[1]);
        r.onerror = reject;
        r.readAsDataURL(file);
      });
    }

    // Initial focus
    window.addEventListener('load', ()=> input.focus());

    // ===== Scroll-reveal for cards/messages if you add any static content later
    const io = new IntersectionObserver((entries)=>{
      for(const e of entries){
        if(e.isIntersecting){ e.target.style.transition='transform .5s ease, opacity .5s ease'; e.target.style.transform='none'; e.target.style.opacity='1'; io.unobserve(e.target) }
      }
    }, {threshold:.15});
    document.querySelectorAll('.message,.chip').forEach(el=> io.observe(el));
  </script>
</body>
</html>
